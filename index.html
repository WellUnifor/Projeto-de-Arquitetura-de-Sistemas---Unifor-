<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consumidor de Receitas</title>
</head>
<body>

<h1>Receitas Culinárias</h1>

<ul id="receitas-lista"></ul>

<script>

    function iniciarServidor() {
            // Use JavaScript para iniciar o servidor (esse código é um exemplo e pode não funcionar em todos os ambientes)
            const { exec } = require('child_process');
            const serverProcess = exec('node server.js');

            // Lidar com a saída do processo (opcional)
            serverProcess.stdout.on('data', (data) => {
                console.log(`Saída do servidor: ${data}`);
            });

            serverProcess.stderr.on('data', (data) => {
                console.error(`Erro do servidor: ${data}`);
            });

            serverProcess.on('close', (code) => {
                console.log(`Servidor encerrado com código ${code}`);
            });
    }

    const listaReceitas = document.getElementById('receitas-lista');

    async function carregarReceitas() {
    const resposta = await fetch('http://localhost:3000/receitas');
    const receitas = await resposta.json();

    receitas.forEach(async (receita) => {
        const ingredientesFaltando = await verificarEstoque(receita.ingredientes);

        const itemLista = document.createElement('li');
        itemLista.textContent = `${receita.nome} - Calorias: ${receita.calorias}`;

        if (ingredientesFaltando.length === 0) {
            itemLista.textContent += ' (Ingredientes Disponíveis)';
        } else {
            itemLista.textContent += ` (Ingredientes Faltando: ${ingredientesFaltando.join(', ')})`;
            adicionarListaCompras(ingredientesFaltando);
        }

        listaReceitas.appendChild(itemLista);
    });
}

async function verificarEstoque(ingredientes) {
    try {
        const resposta = await fetch('http://localhost:3000/estoque');
        const estoque = await resposta.json();

        // Filtrar os ingredientes que estão ausentes no estoque
        const ingredientesFaltando = ingredientes.filter(ingrediente => !estoque.some(item => item.nome === ingrediente));

        return ingredientesFaltando;
    } catch (error) {
        console.error('Erro ao verificar o estoque:', error.message);
        return [];
    }
}

async function adicionarListaCompras(ingredientes) {
    try {
        for (const ingrediente of ingredientes) {
            const resposta = await fetch('http://localhost:3000/lista', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ ingrediente }),
            });

            if (!resposta.ok) {
                throw new Error(`Erro ao adicionar "${ingrediente}" à lista de compras`);
            }
        }
    } catch (error) {
        console.error(error.message);
    }
}

    async function adicionarReceita() {
        const nome = prompt('Digite o nome da receita:');
        const calorias = prompt('Digite as calorias da receita:');
        const ingredientes = prompt('Digite os ingredientes (separados por vírgula):').split(',');

        const novaReceita = { nome, calorias: parseInt(calorias), ingredientes };

        const resposta = await fetch('http://localhost:3000/receitas', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(novaReceita)
        });

        if (resposta.ok) {
            carregarReceitas();
        } else {
            console.error('Erro ao adicionar receita');
        }
    }

    carregarReceitas();
</script>

</body>
</html>
